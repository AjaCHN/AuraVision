# 用户界面功能规范

## 功能概述
用户界面模块是 SonicVision 的交互核心，负责提供直观的用户体验，包括可视化效果展示、控制选项、歌曲信息显示和多语言支持。该模块基于 React 组件架构，实现了响应式设计和流畅的用户交互。

## 核心组件

### VisualizerCanvas

#### 功能描述
- **主画布**：显示 2D 音频可视化效果
- **歌词显示**：可选显示歌曲歌词
- **响应式**：自适应窗口大小

#### 属性
- **analyser**：AudioContext 的 AnalyserNode 实例
- **mode**：VisualizerMode 枚举值，指定可视化模式
- **colors**：string[]，颜色主题数组
- **settings**：VisualizerSettings 对象，可视化设置
- **song**：SongInfo 对象，当前识别的歌曲信息
- **showLyrics**：boolean，是否显示歌词
- **lyricsStyle**：LyricsStyle 枚举值，歌词显示风格

#### 实现细节
- 使用 Canvas 2D API 渲染可视化效果
- 根据当前模式选择对应的渲染策略
- 响应音频频率数据更新可视化效果
- 支持多种歌词显示风格

### ThreeVisualizer

#### 功能描述
- **3D 可视化**：使用 WebGL 显示 3D 音频可视化效果
- **高性能**：优化的 WebGL 渲染
- **沉浸式**：提供深度感和空间感

#### 属性
- **analyser**：AudioContext 的 AnalyserNode 实例
- **mode**：VisualizerMode 枚举值，指定 3D 可视化模式
- **colors**：string[]，颜色主题数组
- **settings**：VisualizerSettings 对象，可视化设置

#### 实现细节
- 使用 Three.js 创建 WebGL 场景
- 根据音频数据更新 3D 几何体
- 实现平滑的相机控制和灯光效果
- 支持三种 3D 可视化模式：SILK、LIQUID、TERRAIN

### Controls

#### 功能描述
- **模式选择**：切换不同的可视化模式
- **主题选择**：选择颜色主题
- **麦克风控制**：开启/关闭麦克风
- **歌词控制**：控制歌词显示和风格
- **语言设置**：切换界面语言
- **区域设置**：选择用户区域
- **可视化设置**：调整灵敏度、速度等参数
- **设备选择**：选择音频输入设备

#### 属性
- **currentMode**：VisualizerMode，当前可视化模式
- **setMode**：函数，设置可视化模式
- **colorTheme**：string[]，当前颜色主题
- **setColorTheme**：函数，设置颜色主题
- **toggleMicrophone**：函数，切换麦克风状态
- **isListening**：boolean，麦克风是否开启
- **isIdentifying**：boolean，是否正在识别歌曲
- **lyricsStyle**：LyricsStyle，当前歌词风格
- **setLyricsStyle**：函数，设置歌词风格
- **showLyrics**：boolean，是否显示歌词
- **setShowLyrics**：函数，设置是否显示歌词
- **language**：Language，当前界面语言
- **setLanguage**：函数，设置界面语言
- **region**：Region，当前用户区域
- **setRegion**：函数，设置用户区域
- **settings**：VisualizerSettings，当前可视化设置
- **setSettings**：函数，设置可视化设置
- **resetSettings**：函数，重置设置到默认值
- **randomizeSettings**：函数，随机化设置
- **audioDevices**：AudioDevice[]，可用音频设备列表
- **selectedDeviceId**：string，当前选中的设备ID
- **onDeviceChange**：函数，处理设备选择变化

#### 实现细节
- 使用 React 函数组件和 Hooks
- 响应式布局，适配不同屏幕尺寸
- 实时反馈麦克风和识别状态
- 提供直观的滑块和选择器控件

### SongOverlay

#### 功能描述
- **歌曲信息**：显示识别的歌曲标题和艺术家
- **歌词显示**：显示歌曲歌词
- **情绪标签**：显示歌曲情绪
- **控制按钮**：重试识别或关闭

#### 属性
- **song**：SongInfo，当前识别的歌曲信息
- **lyricsStyle**：LyricsStyle，歌词显示风格
- **showLyrics**：boolean，是否显示歌词
- **language**：Language，界面语言
- **onRetry**：函数，重试识别
- **onClose**：函数，关闭覆盖层
- **analyser**：AudioContext 的 AnalyserNode 实例
- **sensitivity**：number，灵敏度设置

#### 实现细节
- 半透明覆盖层设计
- 平滑的显示/隐藏动画
- 响应歌曲信息更新
- 支持多种歌词显示风格

### HelpModal

#### 功能描述
- **帮助信息**：显示应用使用说明
- **快捷键**：显示键盘快捷键
- **版本信息**：显示应用版本

#### 实现细节
- 模态框设计，覆盖在主界面上
- 响应式布局，适配不同屏幕尺寸
- 支持键盘快捷键关闭

## 界面布局

### 整体结构

#### 主布局
- **背景**：全屏可视化效果
- **覆盖层**：SongOverlay 显示在可视化效果上方
- **控制面板**：Controls 组件固定在底部或侧边
- **帮助模态框**：HelpModal 按需显示

#### 响应式设计
- **桌面设备**：完整的控制面板，支持所有功能
- **移动设备**：简化的控制面板，优先显示核心功能
- **触摸支持**：优化的触摸交互

### 交互流程

#### 首次启动
1. **权限请求**：请求麦克风访问权限
2. **默认设置**：加载默认可视化模式和主题
3. **设备检测**：检测并列出可用的音频设备
4. **欢迎界面**：显示简短的使用说明

#### 日常使用
1. **麦克风控制**：用户开启/关闭麦克风
2. **模式选择**：用户选择喜欢的可视化模式
3. **主题调整**：用户选择或自定义颜色主题
4. **设置优化**：用户调整可视化设置
5. **歌曲识别**：系统自动识别正在播放的歌曲
6. **结果查看**：用户查看识别结果和歌词
7. **语言切换**：用户切换界面语言
8. **区域设置**：用户设置所在区域

## 状态管理

### 核心状态

#### 应用状态
- **mode**：VisualizerMode，当前可视化模式
- **colorTheme**：string[]，当前颜色主题
- **settings**：VisualizerSettings，可视化设置
- **isListening**：boolean，麦克风状态
- **isIdentifying**：boolean，识别状态
- **currentSong**：SongInfo，当前识别的歌曲
- **lyricsStyle**：LyricsStyle，歌词风格
- **showLyrics**：boolean，是否显示歌词
- **language**：Language，界面语言
- **region**：Region，用户区域
- **audioDevices**：AudioDevice[]，音频设备列表
- **selectedDeviceId**：string，选中的设备ID

#### 状态持久化
- **localStorage**：使用本地存储持久化用户设置
- **默认值**：当本地存储无数据时使用默认值
- **版本控制**：使用版本号管理存储格式变化

### 状态管理实现

#### React Hooks
- 使用 `useState` 管理组件状态
- 使用 `useEffect` 处理副作用和状态持久化
- 使用 `useRef` 优化性能，避免不必要的渲染

#### 状态更新策略
- **批量更新**：合并相关状态更新，减少渲染次数
- **条件渲染**：根据状态条件渲染组件
- **memoization**：使用 `React.memo` 优化组件渲染

## 多语言支持

### 语言切换

#### 支持语言
- **英语**：默认语言
- **中文**：简体中文支持

#### 实现细节
- **翻译文件**：使用 translations.ts 存储翻译文本
- **语言检测**：自动检测浏览器语言设置
- **手动切换**：用户可在 Controls 组件中手动切换语言

### 区域设置

#### 支持区域
- **global**：全球
- **US**：美国
- **CN**：中国
- **JP**：日本
- **KR**：韩国
- **EU**：欧洲
- **LATAM**：拉丁美洲

#### 实现细节
- **自动检测**：根据浏览器语言自动检测区域
- **手动设置**：用户可在 Controls 组件中手动设置区域
- **区域影响**：影响歌曲识别的区域优先级

## 性能优化

### 渲染优化

#### 组件优化
- **React.memo**：使用 memo 减少不必要的组件渲染
- **useCallback**：缓存回调函数，避免子组件重新渲染
- **useMemo**：缓存计算结果，提高性能

#### 动画优化
- **requestAnimationFrame**：使用浏览器原生动画循环
- **CSS transitions**：使用 CSS 过渡代替 JavaScript 动画
- **硬件加速**：使用 transform 和 opacity 触发硬件加速

### 交互优化

#### 响应速度
- **防抖**：对频繁触发的事件使用防抖处理
- **节流**：对连续触发的事件使用节流处理
- **异步处理**：将耗时操作放在后台执行

#### 触摸体验
- **触摸事件**：优化触摸事件处理
- **手势支持**：支持常见的触摸手势
- **响应区域**：增大触摸目标，提高触摸准确性

## 可访问性

### 键盘导航

#### 支持功能
- **Tab 导航**：所有控件可通过 Tab 键导航
- **键盘快捷键**：支持常用功能的键盘快捷键
- **焦点管理**：清晰的焦点指示

#### 实现细节
- **ARIA 标签**：为所有控件添加 ARIA 标签
- **键盘事件**：处理键盘事件，支持快捷键
- **焦点陷阱**：在模态框中实现焦点陷阱

### 屏幕阅读器

#### 支持功能
- **屏幕阅读器兼容**：所有内容可被屏幕阅读器读取
- **语义化 HTML**：使用语义化的 HTML 元素
- **描述性文本**：提供详细的控件描述

#### 实现细节
- **ARIA 角色**：为组件添加适当的 ARIA 角色
- **aria-label**：为非文本元素添加 aria-label
- **aria-live**：为动态内容添加 aria-live 区域

## 与其他模块的集成

### 与音频处理模块

#### 集成点
- **麦克风控制**：Controls 组件提供麦克风开关
- **设备选择**：Controls 组件提供音频设备选择
- **状态反馈**：显示麦克风状态和设备信息

#### 数据流向
- **设备选择**：Controls → App.tsx → 音频处理模块
- **麦克风状态**：音频处理模块 → App.tsx → Controls

### 与可视化模块

#### 集成点
- **模式选择**：Controls 组件提供可视化模式选择
- **主题控制**：Controls 组件提供颜色主题选择
- **设置调整**：Controls 组件提供可视化设置调整

#### 数据流向
- **用户输入**：Controls → App.tsx → 可视化模块
- **状态更新**：可视化模块 → App.tsx → Controls

### 与歌曲识别模块

#### 集成点
- **识别状态**：显示歌曲识别状态
- **结果展示**：SongOverlay 组件显示识别结果
- **语言设置**：Controls 组件提供语言设置
- **区域设置**：Controls 组件提供区域设置

#### 数据流向
- **识别结果**：歌曲识别模块 → App.tsx → SongOverlay
- **用户设置**：Controls → App.tsx → 歌曲识别模块

## 未来扩展

### 计划中的功能

#### 自定义主题编辑器
- **功能**：允许用户创建和编辑自定义颜色主题
- **实现**：提供颜色选择器和主题预览
- **存储**：将自定义主题保存到本地存储

#### 布局定制
- **功能**：允许用户定制界面布局
- **实现**：可拖动的控制面板，可调整的组件大小
- **存储**：将布局设置保存到本地存储

#### 更多语言支持
- **功能**：添加对更多语言的支持
- **实现**：扩展翻译文件，添加新语言选项

### 技术路线

#### PWA 支持
- **方向**：将应用升级为 Progressive Web App
- **优势**：支持离线使用，可安装到主屏幕

#### 动画库集成
- **方向**：集成现代动画库，如 Framer Motion
- **优势**：提供更流畅、更丰富的动画效果

## 测试策略

### 组件测试

#### 测试框架
- **React Testing Library**：测试组件渲染和交互
- **Jest**：测试组件逻辑

#### 测试重点
- **渲染测试**：确保组件正确渲染
- **交互测试**：确保用户交互正常工作
- **状态测试**：确保状态管理正确
- **响应式测试**：确保在不同屏幕尺寸下正常工作

### 端到端测试

#### 测试框架
- **Cypress**：进行端到端测试

#### 测试场景
- **完整流程**：测试从启动到歌曲识别的完整流程
- **功能测试**：测试所有主要功能
- **兼容性测试**：测试在不同浏览器中的表现
- **性能测试**：测试应用性能和响应时间

### 用户体验测试

#### 测试方法
- **用户测试**：招募用户进行实际使用测试
- **反馈收集**：收集用户反馈和建议
- **A/B 测试**：测试不同界面设计的效果

#### 测试指标
- **易用性**：用户完成任务的难易程度
- **满意度**：用户对界面的满意程度
- **效率**：用户完成任务的速度
- **错误率**：用户操作错误的频率
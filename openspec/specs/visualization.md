# 音频可视化功能规范

## 功能概述
音频可视化模块是 SonicVision 的核心功能之一，负责将音频数据转换为视觉效果。该模块支持多种可视化模式，包括 2D 画布和 3D WebGL 渲染，提供丰富的视觉体验。

## 可视化模式

### 2D 可视化模式

#### BARS
- **描述**：柱状图可视化，根据音频频率显示不同高度的柱状条
- **技术实现**：Canvas 2D API，使用 fillRect 绘制柱状条
- **特点**：响应频率数据，高低频分别对应不同位置的柱状条

#### PLASMA
- **描述**：等离子体效果，使用渐变和噪声函数创建流动的视觉效果
- **技术实现**：Canvas 2D API，使用 createLinearGradient 和 sin/cos 函数
- **特点**：平滑流动的色彩变化，响应音频能量

#### PARTICLES
- **描述**：粒子效果，根据音频数据移动和变换粒子
- **技术实现**：Canvas 2D API，粒子系统和物理模拟
- **特点**：动态粒子运动，响应音频节拍

#### TUNNEL
- **描述**：隧道效果，创建穿越隧道的视觉体验
- **技术实现**：Canvas 2D API，极坐标转换和渐变
- **特点**：深度感强，响应音频能量变化

#### SHAPES
- **描述**：几何形状效果，根据音频数据变换形状
- **技术实现**：Canvas 2D API，路径绘制和变换
- **特点**：抽象几何图形，响应音频频率

#### RINGS
- **描述**：环形效果，显示同心圆环的变化
- **技术实现**：Canvas 2D API，使用 arc 绘制圆环
- **特点**：多层次圆环，响应音频能量

#### NEBULA
- **描述**：星云效果，创建类似星云的扩散效果
- **技术实现**：Canvas 2D API，径向渐变和噪声函数
- **特点**：柔和的色彩扩散，响应音频能量

#### KALEIDOSCOPE
- **描述**：万花筒效果，创建对称的镜像图案
- **技术实现**：Canvas 2D API，变换和裁剪
- **特点**：对称几何图案，响应音频数据

#### LASERS
- **描述**：激光效果，模拟激光束的移动
- **技术实现**：Canvas 2D API，线条绘制和渐变
- **特点**：锐利的线条效果，响应音频节拍

#### STROBE
- **描述**：频闪效果，根据音频节拍闪烁
- **技术实现**：Canvas 2D API，透明度控制
- **特点**：强烈的视觉冲击，响应音频节拍

### 3D 可视化模式（WebGL）

#### SILK
- **描述**：丝绸效果，创建流畅的丝带状 3D 效果
- **技术实现**：WebGL，使用 Three.js 创建动态几何体
- **特点**：流畅的 3D 曲线，响应音频能量

#### LIQUID
- **描述**：液体效果，模拟液体表面的波动
- **技术实现**：WebGL，使用 Three.js 平面几何体和顶点着色器
- **特点**：真实的液体波动，响应音频频率

#### TERRAIN
- **描述**：地形效果，创建起伏的地形可视化
- **技术实现**：WebGL，使用 Three.js 高度场
- **特点**：3D 地形起伏，响应音频频率

## 可视化设置

### 核心设置

#### sensitivity
- **类型**：number（1.0 到 3.0）
- **默认值**：1.5
- **描述**：控制可视化效果对音频的敏感度
- **实现**：影响音频数据的放大倍数

#### speed
- **类型**：number（0.5 到 2.0）
- **默认值**：1.0
- **描述**：控制可视化效果的动画速度
- **实现**：影响动画帧之间的时间间隔

#### glow
- **类型**：boolean
- **默认值**：true
- **描述**：启用或禁用发光效果
- **实现**：使用 shadowBlur 属性或 shader 效果

#### trails
- **类型**：boolean
- **默认值**：true
- **描述**：启用或禁用轨迹效果
- **实现**：使用半透明背景重绘

#### autoRotate
- **类型**：boolean
- **默认值**：false
- **描述**：是否自动切换可视化模式
- **实现**：使用 setInterval 定期切换模式

#### rotateInterval
- **类型**：number
- **默认值**：30
- **描述**：自动切换模式的时间间隔（秒）
- **实现**：setInterval 的时间参数

#### hideCursor
- **类型**：boolean
- **默认值**：false
- **描述**：是否隐藏鼠标光标
- **实现**：CSS cursor 属性控制

## 技术实现

### 渲染策略

#### IVisualizerRenderer 接口
```typescript
export interface IVisualizerRenderer {
  init(canvas: HTMLCanvasElement): void;
  draw(
    ctx: CanvasRenderingContext2D, 
    data: Uint8Array, 
    width: number, 
    height: number, 
    colors: string[], 
    settings: VisualizerSettings,
    rotation: number
  ): void;
  cleanup?(): void;
}
```

### 2D 渲染实现
- **核心组件**：VisualizerCanvas.tsx
- **数据来源**：AnalyserNode.getByteFrequencyData()
- **渲染流程**：
  1. 获取音频频率数据
  2. 根据当前模式选择对应的渲染策略
  3. 调用渲染策略的 draw 方法
  4. 应用颜色主题和设置

### 3D 渲染实现
- **核心组件**：ThreeVisualizer.tsx
- **技术栈**：Three.js
- **渲染流程**：
  1. 初始化 Three.js 场景、相机和渲染器
  2. 根据当前模式创建对应的 3D 几何体
  3. 使用音频数据更新几何体属性
  4. 应用材质和光照效果
  5. 执行渲染循环

## 颜色主题

### 内置主题
- **默认主题**：蓝色渐变
- **可用主题**：多种预设颜色组合，存储在 COLOR_THEMES 常量中
- **自定义主题**：支持用户自定义颜色组合

### 主题应用
- **实现**：使用 Canvas 2D API 的 createLinearGradient 或 Three.js 的材质颜色
- **效果**：不同主题提供完全不同的视觉体验

## 与其他模块的集成

### 与音频处理模块
- **数据流向**：音频处理模块 → AnalyserNode → 可视化模块
- **集成点**：App.tsx 中的 analyser 状态传递

### 与歌曲识别模块
- **集成点**：当识别到歌曲时，可视化效果可以响应歌曲信息
- **实现**：SongOverlay 组件显示歌曲信息，VisualizerCanvas 可选显示歌词

### 与用户界面模块
- **集成点**：Controls 组件提供可视化模式和设置的控制
- **实现**：通过 props 传递模式和设置状态

## 性能优化

### 渲染优化
- **requestAnimationFrame**：使用浏览器原生动画循环
- **Canvas 尺寸控制**：根据屏幕尺寸调整画布大小
- **WebGL 优化**：合理使用几何体和材质，避免过度绘制

### 计算优化
- **频率数据处理**：使用 Uint8Array 存储音频数据
- **数学计算优化**：避免重复计算，使用缓存
- **条件渲染**：根据需要启用或禁用复杂效果

## 响应式设计

### 画布尺寸
- **实现**：监听窗口 resize 事件，调整画布大小
- **效果**：适配不同屏幕尺寸，保持视觉效果比例

### 移动设备优化
- **实现**：检测设备类型，调整渲染复杂度
- **效果**：在移动设备上保持流畅运行

## 未来扩展

### 计划中的功能
- **更多 3D 模式**：添加更多基于 WebGL 的 3D 可视化效果
- **交互式可视化**：支持用户交互控制可视化效果
- **音频响应增强**：更精确地响应音频的不同元素
- **自定义 shader**：支持用户自定义 WebGL shader

### 技术路线
- **WebGPU 支持**：未来考虑使用 WebGPU 提升渲染性能
- **机器学习增强**：使用 AI 生成更智能的可视化效果